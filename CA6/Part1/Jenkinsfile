pipeline {
    agent any

    environment {
        // Define path to the Gradle wrapper
        GRADLE_WRAPPER = './gradlew'
        // Define path to the Ansible playbook
        ANSIBLE_PLAYBOOK = 'ansible/playbook.yml'
        // Define path to the Ansible inventory
        ANSIBLE_INVENTORY = 'ansible/inventory'
        // Ensure Vagrant and Ansible are in the PATH
        PATH = "/usr/local/bin:/Users/mariozito/.local/bin:$PATH"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Assemble') {
            steps {
                dir('CA6/Part1/gradle_basic_demo') {
                    sh 'chmod +x gradlew'
                    sh './gradlew clean assemble'
                }
            }
        }

        stage('Test') {
            steps {
                dir('CA6/Part1/gradle_basic_demo') {
                    sh './gradlew test'
                }
            }
            post {
                always {
                    dir('CA6/Part1/gradle_basic_demo') {
                        junit 'build/test-results/test/*.xml'
                    }
                }
            }
        }

        stage('Archive') {
            steps {
                dir('CA6/Part1/gradle_basic_demo') {
                    archiveArtifacts artifacts: 'build/libs/*.jar', fingerprint: true
                }
            }
        }

        stage('Provision Infrastructure') {
            steps {
                dir('CA6/Part1') {
                    // Bring up the VMs using VMware Fusion
                    sh 'vagrant up --provider=vmware_desktop'
                    // Validate they are running
                    sh 'vagrant status'
                }
            }
        }

        stage('Deploy to Blue') {
            steps {
                dir('CA6/Part1') {
                    // Ensure permissions for private keys
                    sh 'chmod 600 .vagrant/machines/blue/vmware_desktop/private_key || true'
                    
                    // Run Ansible playbook targeting 'blue'
                    sh """
                        ansible-playbook -i ${ANSIBLE_INVENTORY} ${ANSIBLE_PLAYBOOK} \
                        --limit blue \
                        --extra-vars "jar_source=${WORKSPACE}/CA6/Part1/gradle_basic_demo/build/libs/GradleProject_Transformation.jar ansible_ssh_private_key_file=${WORKSPACE}/CA6/Part1/.vagrant/machines/blue/vmware_desktop/private_key"
                    """
                }
            }
        }

        stage('Deploy to Production?') {
            steps {
                input message: 'Deploy to Production?', ok: 'Deploy'
            }
        }

        stage('Deploy') {
            steps {
                dir('CA6/Part1') {
                    // Ensure permissions for private keys
                    sh 'chmod 600 .vagrant/machines/green/vmware_desktop/private_key || true'
                    
                    // Run Ansible playbook targeting 'green'
                    sh """
                        ansible-playbook -i ${ANSIBLE_INVENTORY} ${ANSIBLE_PLAYBOOK} \
                        --limit green \
                        --extra-vars "jar_source=${WORKSPACE}/CA6/Part1/gradle_basic_demo/build/libs/GradleProject_Transformation.jar ansible_ssh_private_key_file=${WORKSPACE}/CA6/Part1/.vagrant/machines/green/vmware_desktop/private_key"
                    """
                }
            }
        }
    }
}
