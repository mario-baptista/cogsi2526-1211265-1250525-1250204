pipeline {
    agent any

    environment {
        // Define path to the Gradle wrapper
        GRADLE_WRAPPER = './gradlew'
        // Define path to the Ansible playbook
        ANSIBLE_PLAYBOOK = 'ansible/playbook.yml'
        // Define path to the Ansible inventory
        ANSIBLE_INVENTORY = 'ansible/inventory'
        // Ensure Vagrant and Ansible are in the PATH
        PATH = "/usr/local/bin:/Users/mariozito/.local/bin:$PATH"
    }

    stages {
        stage('Build') {
            steps {
                dir('CA6/Part1/gradle_basic_demo') {
                    sh 'chmod +x gradlew'
                    sh './gradlew clean build'
                }
            }
        }

        stage('Archive') {
            steps {
                dir('CA6/Part1/gradle_basic_demo') {
                    archiveArtifacts artifacts: 'build/libs/*.jar', fingerprint: true
                }
            }
        }

        stage('Provision Infrastructure') {
            steps {
                dir('CA6/Part1') {
                    // Bring up the VMs using VMware Fusion
                    sh 'vagrant up --provider=vmware_desktop'
                    // Validate they are running
                    sh 'vagrant status'
                }
            }
        }

        stage('Deploy to Blue') {
            steps {
                dir('CA6/Part1') {
                    // Ensure permissions for private keys (Jenkins might need this)
                    // .vagrant is in the current directory (CA6/Part1)
                    // Updated path for VMware Fusion
                    sh 'chmod 600 .vagrant/machines/blue/vmware_desktop/private_key || true'
                    
                    // Run Ansible playbook using shell command
                    // This avoids the need for the Jenkins Ansible plugin
                    sh """
                        ansible-playbook -i ${ANSIBLE_INVENTORY} ${ANSIBLE_PLAYBOOK} \
                        --limit blue \
                        --extra-vars "jar_source=${WORKSPACE}/CA6/Part1/gradle_basic_demo/build/libs/basic_demo-0.1.0.jar"
                    """
                }
            }
        }
    }
}
